<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://nannaer.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://nannaer.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-分布式系统" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/04/17/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" class="article-date">
  <time datetime="2023-04-17T07:15:14.306Z" itemprop="datePublished">2023-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="分布式系统（仅用于个人学习，笔记）"><a href="#分布式系统（仅用于个人学习，笔记）" class="headerlink" title="分布式系统（仅用于个人学习，笔记）"></a>分布式系统（仅用于个人学习，笔记）</h1><h2 id="1-1-认识分布式系统"><a href="#1-1-认识分布式系统" class="headerlink" title="1.1 认识分布式系统"></a>1.1 认识分布式系统</h2><p>分布式系统有以下特点：</p>
<p>（1）多进程。分布式系统中有多个进程并发运行</p>
<p>（2）不共享操作系统。通过网络通信传递消息来协作</p>
<p>（3）不共享时钟。所以很难只通过时间来定义两个事件的顺序</p>
<h2 id="1-2-分布式系统的挑战"><a href="#1-2-分布式系统的挑战" class="headerlink" title="1.2 分布式系统的挑战"></a>1.2 分布式系统的挑战</h2><h3 id="1-2-1网络延迟问题"><a href="#1-2-1网络延迟问题" class="headerlink" title="1.2.1网络延迟问题"></a>1.2.1网络延迟问题</h3><p>分布式系统中的多个节点通过网络进行通信，但网络并不能保证数据什么时候到达，以及是否一定到达，有时网络甚至是不安全的。</p>
<p>例如，分布式系统中的消息传递可能会出现以下问题：</p>
<p>（1）消息丢失了</p>
<p>（2）我们可能认为消息丢失了，但实际上消息只是延迟到达</p>
<p>（3）网络可能会重传消息，导致收到重复的消息</p>
<p>（4）消息延迟可能会让我们认为某个服务已经因故障下线，但实际上没有</p>
<p>（5）消息可能以不同的顺序到达，或者不同的节点上消息到达的顺序不同</p>
<h3 id="1-2-2部分失效问题"><a href="#1-2-2部分失效问题" class="headerlink" title="1.2.2部分失效问题"></a>1.2.2部分失效问题</h3><p>在分布式系统中，系统可能一部分节点正常工作，而另一部分节点停止运行，或另一部分其实正常运行，但由于网络中断导致无法协同工作。系统的某些部分可能会以不可预知的方式宕机，这被称为“<em><strong>部分失效</strong></em>”。</p>
<p>难点在于部分失效是<em><strong>不确定的</strong></em>：如果你视图做任何涉及多个节点和网络的事情，那么它有时可能会工作，有时可能会出现不可预知的失败。</p>
<p>这种不确定性和部分失效的可能性，使得分布式系统难以捉摸和调试。尤其是当你的操作需要原子性时——要么在所有节点都成功，要么在所有节点都失败。在这种情况下，部分失效就会带来很大的复杂性和挑战，甚至严重影响系统的性能。</p>
<h3 id="1-2-3时钟问题"><a href="#1-2-3时钟问题" class="headerlink" title="1.2.3时钟问题"></a>1.2.3时钟问题</h3><p>分布式系统中，每台机器有自己的时钟，各个物理设备的本地时钟走时并不准确，可能比其他机器稍快或更慢。</p>
<p>另外，消息通过网络从一台机器传送到另一台机器也需要时间，但由于网络中的可变延迟，我们不知道消息传递到底花了多少时间。</p>
<h3 id="1-3-每个程序员都应该知道的数字"><a href="#1-3-每个程序员都应该知道的数字" class="headerlink" title="1.3 每个程序员都应该知道的数字"></a>1.3 每个程序员都应该知道的数字</h3><p><img src="https://yygh-testosscjf.oss-cn-beijing.aliyuncs.com/IMG_20230417_150820_edit_5094932810995.jpg" alt="IMG_20230417_150820_edit_5094932810995"></p>
<p><img src="https://yygh-testosscjf.oss-cn-beijing.aliyuncs.com/IMG_20230417_150835.jpg" alt="IMG_20230417_150835"></p>
<p>延迟（<code>Latency</code>），带宽（<code>BandWidth</code>）和吞吐量（<code>Throughput</code>）之间有什么区别？</p>
<p>用水管来举例，延迟表示通过管道需要花费的时间，带宽表示水管管道的宽度，每秒流过的水的数量就是吞吐量。</p>
<h2 id="2-分布式系统模型"><a href="#2-分布式系统模型" class="headerlink" title="2 分布式系统模型"></a>2 分布式系统模型</h2><h3 id="2-1-两将军问题"><a href="#2-1-两将军问题" class="headerlink" title="2.1 两将军问题"></a>2.1 两将军问题</h3><p>这座城市防守坚固，要想顺利占领它，两支军队必须同时进攻。如果同一时间仅一支军队进攻，将会战败。</p>
<p>同时，两位将军必须通过信使沟通并约定攻击时间，并且他们都必须确保另一位将军知道自己已同意了进攻计划，但由于传递确认消息的信使可能被俘虏造成消息丢失，即使双方不断确认已收到对方的上一条消息，也无法确保对方已与自己达成共识。</p>
<p>TCP的<em><strong>“三次握手”</strong></em>就是两将军问题的一个工程解。</p>
<h3 id="2-2-拜占庭将军问题"><a href="#2-2-拜占庭将军问题" class="headerlink" title="2.2 拜占庭将军问题"></a>2.2 拜占庭将军问题</h3><p>拜占庭故障模型描述的是系统中某些成员计算机不仅会发生故障和出现错误，甚至会故意篡改，<em><strong>破坏和控制系统的系统模型</strong></em>。</p>
<h3 id="2-3-系统模型"><a href="#2-3-系统模型" class="headerlink" title="2.3 系统模型"></a>2.3 系统模型</h3><p><strong>2.3.1 网络链路模型</strong></p>
<p><em><strong>网络分区</strong></em>指节点仍然正常工作，但它们之间的通信连接已经中断。</p>
<p>假设我们有一个发送者和接收者，它们通过一个双向的链路通信。一个链路有两个最基本的事件：<strong>发送事件</strong>，即将一条消息发送到链路上；<strong>接收事件</strong>，链路返回一条消息。</p>
<p>1.<em><strong>可靠链路</strong></em></p>
<p>可靠链路也称为完美链路。完美链路既不会丢失消息，也不会凭空捏造消息，但它<em><strong>可能会对消息重新排序</strong></em>。它有如下特点：</p>
<p>（1）可靠链路：如果进程p和q都正常工作，则进程p发送到q的每个消息都会被链路传递。</p>
<p>（2）没有重复：每条消息最多传递一次。</p>
<p>（3）不会无中生有：链路不会自己生成消息。换句话说，它不会传递一个从未发送过的消息。</p>
<p>2.<em><strong>公平损失链路</strong></em></p>
<p>公平损失链路消息可能会丢失，重复或重新排序，但消息最终会到达。公平损失链路有如下特点：</p>
<p>（1）公平损失：如果发送方和接收方都是正常运行的，且发送方不断重复发送消息，则消息最终会被送达。</p>
<p>（2）有限重复：消息只会重复发送有限的次数。</p>
<p>（3）不会无中生有：链路不会自己生成消息。这个特点和可靠链路一样。</p>
<p>3.<em><strong>任意链路</strong></em></p>
<p>任意链路是最弱的一种网络链路模型。这种网络链路允许任意的网络链路执行任意操作。</p>
<p><em><strong>这三种网络模型是可以相互转换的</strong></em>。例如，对于公平损失链路，可以通过不断重传丢失的消息，直到接收者接收到它们，并让接收者过滤重复的消息，把一条公平损失链路变成一条可靠链路。公正损失假设意味着任何网络分区（网络中断）只会持续有限的时间，不会永远持续下去，所以我们可以保证每条消息最终都会被接收。</p>
<p>使用加密技术可以将任意链路变成公平损失链路，例如<code>HTTPS</code>中使用<code>TLS</code>加密</p>
<p><strong>2.3.2 节点故障类型</strong></p>
<p>节点在回复消息时可能出现故障，从而导致该消息永久丢失，这就是节点故障问题。</p>
<p>故障类型主要分为以下三种类型：<strong>崩溃——停止（fail-stop），崩溃——恢复（fail-recover），拜占庭故障</strong>。</p>
<p>（1）崩溃——停止指一个节点停止工作后永远不会恢复。这可能是不可恢复的硬件故障，例如手机掉进马桶，意味着手机永久失灵。</p>
<p>（2）崩溃——恢复允许节点重新启动并继续执行剩余的步骤，一般通过持久化存储必要的信息来容忍这种故障类型。</p>
<p>（3）拜占庭故障如拜占庭将军问题一样，故障的节点可能不只会宕机，还可能以任意方式偏离算法，甚至恶意破坏系统。</p>
<p><strong>2.3.3 按时间划分系统模型</strong></p>
<p><strong>同步</strong>（Synchronous）系统模型是指，一个消息的响应时间在一个有限且已知的时间范围内。<strong>异步</strong>（Asynchronous）系统模型是指，一个消息的响应时间是无限的，无法知道一条消息什么时候会到达。</p>
<p><em><strong>异步系统才是更接近现实的系统</strong></em>。我们无法确保整个系统的所有组件都正常运行，因此在两地之间发送的消息得不到在有限时间内响应的保证。操作系统因内存不足挂起一个线程；Stop the World（垃圾回收也会暂停正在运行的线程）。即使这些情况很少发生，但只是短时间内的失效，就会使基于同步系统的假设失效，为同步系统设计的应用也随之出错。</p>
<p>为异步系统设计的算法是非常健壮的，因为它们不受任何临时网络中断或延迟的影响。不幸的是，分布式系统中的一些问题在异步系统中无法解决，比如<code>FLP</code>不可能定理，因此引出了第三种模型——部分同步（Partially Synchronous）系统。</p>
<p>在部分同步系统模型中，我们假设系统在大部分时间是同步的，但偶尔会因为故障转变为异步系统。</p>
<h3 id="2-4-消息传递语义"><a href="#2-4-消息传递语义" class="headerlink" title="2.4 消息传递语义"></a>2.4 消息传递语义</h3><p>由于网络和节点不可靠，这些消息可能会丢失，为了解决消息丢失问题，会让节点重复发送信息，这意味着消息可能会发送多次。例如重传消息正好是用户银行扣款信息。</p>
<p>上述问题最常见的解决方法是幂等操作。<em><strong>幂等操作</strong></em>是指多次操作产生相同的结果，且不会有任何其他影响。</p>
<p>幂等操作会对系统进行严格的约束，我们总是无法准确知道另一端操作结果是成功还是失败，我们只能一直等待确认请求，保证每个操作都是幂等的代价是昂贵的。在大多数情况下，我们可以给每条消息一个唯一的表示符，接收者可以避免执行执行过的操作。</p>
<p>按照消息传递和处理次数，有如下几种可能的消息传递语义：</p>
<p>（1）<strong>最多一次</strong>（At Most Once）：消息最多传递一次，消息可能丢失，但不会重复。</p>
<p>（2）<strong>至少一次</strong>（At Least Once）：系统保证每条消息至少会发送一次，消息不会丢失，但在有故障的情况下可能导致消息重复发送。</p>
<p>（3）<strong>精准一次</strong>（Exactly Once）：消息只会被精确传递一次。消息不丢失不重复。</p>
<p>我们关心的是消息被处理的次数，而不是消息被送达的次数。精确传递一次难以实现，因为想要建立可靠的链路，就必须重复传递某些信息。于是我们尽可能做到精确处理一次消息，然后通过忽略后续重复的消息来达到看起来是精准一次的效果。</p>
<p><strong>对于一些流式处理框架或消息队列来说，实现精准一次语义是非常重要的，尤其是输出端实现“精准一次”输出数据。</strong></p>
<h2 id="3-分布式数据基础"><a href="#3-分布式数据基础" class="headerlink" title="3 分布式数据基础"></a>3 分布式数据基础</h2><p>本章我们重点讨论分布式数据基础，涉及从单台机器转到分布式系统后，我们该如何分散存储数据集，该如何进行数据同步。软件工程没有银弹，引入分布式系统是万能解药吗？什么是数据一致性？什么是强一致性，弱一致性和最终一致性？</p>
<p><strong>3.1 分区</strong></p>
<p><strong>垂直分区和水平分区</strong></p>
<p>垂直分区是对表的列进行拆分，每个分区都包含了其中列对应的所有行。例如，可以将不经常使用的列或者一个包含了大text类型或BLOB类型的列垂直分区。</p>
<p>水平分区是对表的行进行拆分。例如将一个包含十年订单记录的表水平拆分为十个不同的分区。</p>
<p><strong>3.1.1 水平分区算法</strong></p>
<p>（1）<em>范围分区</em></p>
<p>根据指定的关键字将数据集拆分为若干连续的范围，每个范围存储到一个单独的节点上。</p>
<p><em><strong>缺点</strong></em>：</p>
<ol>
<li>无法使用分区键之外的其他关键字进行范围查询</li>
<li>当查询的范围比较大且位于多个节点时，性能较差</li>
<li>某些数据热点现象，从而造成某些节点负载很高</li>
</ol>
<p>（2）<em>哈希分区</em></p>
<p>将指定的关键字经过一个哈希函数的计算，根据计算得到的值决定该数据集的分区。</p>
<p>哈希分区的<em><strong>优点</strong></em>是数据分布几乎随机，相对均匀，能够在一定程度避免热点问题。</p>
<p>哈希分区的<em><strong>缺点</strong></em>是：</p>
<ol>
<li>在不额外存储数据的情况下，无法执行范围查询</li>
<li>在添加或删除节点时，由于每个节点都需要一个相应的哈希值，所以增加节点需要修改哈希函数，这会导致许多现有的数据都要重新映射，引起数据大规模移动，并且在此期间，系统可能无法继续工作</li>
</ol>
<p>（3）一致性哈希</p>
<p>在分布式系统中用来缓解哈希分区增加或删除节点时引起的大规模数据移动问题。</p>
<p>一致性哈希算法将整个哈希值组织成一个抽象的圆环，称为哈希环。</p>
<ol>
<li>将分布式系统节点映射到圆环上</li>
<li>将需要存储的数据的关键字输入哈希函数，计算出哈希值，根据哈希值将数据映射到哈希环上</li>
<li>向集群中新添加一个节点，按照顺时针计算的方法，原本存储到节点<code>N2</code>上的关键字a将转移到<code>N4</code>上，其他数据保持不动</li>
</ol>
<p><strong>一致性哈希对于节点的增减只需要重新分配哈希环上的一部分数据，改善了哈希分区大规模迁移的缺点。此外，一致性哈希也不需要修改哈希函数，直接将新节点指定到哈希环上的某个位置即可。</strong></p>
<p><strong>但是，一致性哈希仍然有明显的缺点，当系统节点太少时，还是容易产生数据分布不均的问题。另外，一个较为严重的缺点是，当一个节点发生异常需要下线时，该节点的数据全部转移到顺时针方向的节点上，从而导致顺时针方向节点存储大量数据，大量负载会倾斜到该节点。</strong></p>
<p>解决方案：<strong>引入虚拟节点</strong>，一个物理节点不再只对应哈希环上一个点，而是对应多个节点。虚拟节点越多，数据分布越均匀。</p>
<p>如果系统中有不同性能的机器，虚拟节点也很有用。<strong>例如，系统中有一台机器的性能是其他机器的两倍，那么我们可以让这台机器映射出两倍于其他机器的节点数，让它来承担更多的负担。</strong></p>
<p>不过，在不额外存储数据的情况下，一致性哈希仍然无法高效地进行范围查询，任何范围查询都会发送到多个节点上。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://nannaer.github.io/2023/04/17/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" data-id="clglzl96w0001esv7h3993e1u" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-linuxPL" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/04/15/linuxPL/" class="article-date">
  <time datetime="2023-04-14T16:39:42.219Z" itemprop="datePublished">2023-04-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="linuxPL"><a href="#linuxPL" class="headerlink" title="linuxPL"></a>linuxPL</h1>
        
          <p class="article-more-link">
            <a href="/2023/04/15/linuxPL/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://nannaer.github.io/2023/04/15/linuxPL/" data-id="clglzl95v0000esv780087hql" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/04/17/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/04/15/linuxPL/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>